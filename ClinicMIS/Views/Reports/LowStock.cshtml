@model ClinicMIS.Models.ViewModels.LowStockReportViewModel
@{
    ViewData["Title"] = "Low Stock Report";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div class="text-muted">
        Report generated: @DateTime.Now.ToString("MMMM dd, yyyy HH:mm")
    </div>
    <button onclick="window.print()" class="btn btn-outline-secondary">
        <i class="bi bi-printer me-1"></i> Print Report
    </button>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <div class="display-5 fw-bold text-primary">@Model.TotalDrugs</div>
                <div class="text-muted">Total Drugs</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-warning">
            <div class="card-body text-center">
                <div class="display-5 fw-bold text-warning">@Model.LowStockCount</div>
                <div class="text-muted">Low Stock</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-danger">
            <div class="card-body text-center">
                <div class="display-5 fw-bold text-danger">@Model.OutOfStockCount</div>
                <div class="text-muted">Out of Stock</div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card border-info">
            <div class="card-body text-center">
                <div class="display-5 fw-bold text-info">@Model.ExpiringCount</div>
                <div class="text-muted">Expiring Soon</div>
            </div>
        </div>
    </div>
</div>

<!-- Out of Stock Items -->
@if (Model.OutOfStockItems.Any())
{
    <div class="card mb-4 border-danger">
        <div class="card-header bg-danger text-white">
            <i class="bi bi-x-circle me-2"></i>Out of Stock (@Model.OutOfStockCount items)
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Drug Code</th>
                            <th>Drug Name</th>
                            <th>Category</th>
                            <th class="text-end">Reorder Level</th>
                            <th class="text-end">Est. Reorder Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var drug in Model.OutOfStockItems)
                        {
                            <tr class="table-danger">
                                <td><code>@drug.DrugCode</code></td>
                                <td><strong>@drug.DrugName</strong></td>
                                <td>@drug.Category</td>
                                <td class="text-end">@drug.ReorderLevel</td>
                                <td class="text-end">@drug.ReorderCost.ToString("C")</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <td colspan="4" class="text-end fw-bold">Total Reorder Cost:</td>
                            <td class="text-end fw-bold">@Model.OutOfStockItems.Sum(d => d.ReorderCost).ToString("C")</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
}

<!-- Low Stock Items -->
@if (Model.LowStockItems.Any())
{
    <div class="card mb-4 border-warning">
        <div class="card-header bg-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>Low Stock (@Model.LowStockCount items)
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Drug Code</th>
                            <th>Drug Name</th>
                            <th>Category</th>
                            <th class="text-center">Current Stock</th>
                            <th class="text-center">Reorder Level</th>
                            <th class="text-center">Shortfall</th>
                            <th class="text-end">Est. Reorder Cost</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var drug in Model.LowStockItems)
                        {
                            <tr class="table-warning">
                                <td><code>@drug.DrugCode</code></td>
                                <td>@drug.DrugName</td>
                                <td>@drug.Category</td>
                                <td class="text-center">
                                    <span class="badge bg-warning text-dark">@drug.CurrentStock</span>
                                </td>
                                <td class="text-center">@drug.ReorderLevel</td>
                                <td class="text-center text-danger">-@drug.ShortfallQuantity</td>
                                <td class="text-end">@drug.ReorderCost.ToString("C")</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <td colspan="6" class="text-end fw-bold">Total Reorder Cost:</td>
                            <td class="text-end fw-bold">@Model.LowStockItems.Sum(d => d.ReorderCost).ToString("C")</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
}

<!-- Expiring Items -->
@if (Model.ExpiringItems.Any())
{
    <div class="card border-info">
        <div class="card-header bg-info text-white">
            <i class="bi bi-clock me-2"></i>Expiring Soon (@Model.ExpiringCount items)
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Drug Code</th>
                            <th>Drug Name</th>
                            <th>Expiry Date</th>
                            <th class="text-center">Days Until Expiry</th>
                            <th class="text-center">Quantity</th>
                            <th class="text-end">Stock Value</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var drug in Model.ExpiringItems)
                        {
                            <tr class="@(drug.IsExpired ? "table-danger" : drug.DaysUntilExpiry <= 7 ? "table-warning" : "")">
                                <td><code>@drug.DrugCode</code></td>
                                <td>@drug.DrugName</td>
                                <td>@drug.ExpiryDate.ToString("MMM dd, yyyy")</td>
                                <td class="text-center">
                                    @if (drug.IsExpired)
                                    {
                                        <span class="badge bg-danger">EXPIRED</span>
                                    }
                                    else
                                    {
                                        <span class="badge @(drug.DaysUntilExpiry <= 7 ? "bg-warning text-dark" : "bg-info")">
                                            @drug.DaysUntilExpiry days
                                        </span>
                                    }
                                </td>
                                <td class="text-center">@drug.QuantityInStock</td>
                                <td class="text-end">@drug.StockValue.ToString("C")</td>
                            </tr>
                        }
                    </tbody>
                    <tfoot class="table-light">
                        <tr>
                            <td colspan="5" class="text-end fw-bold">Total Stock Value at Risk:</td>
                            <td class="text-end fw-bold text-danger">@Model.ExpiringItems.Sum(d => d.StockValue).ToString("C")</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
}

@if (!Model.OutOfStockItems.Any() && !Model.LowStockItems.Any() && !Model.ExpiringItems.Any())
{
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="bi bi-check-circle fs-1 text-success d-block mb-3"></i>
            <h4 class="text-success">All Stock Levels Normal</h4>
            <p class="text-muted">No drugs are currently low in stock, out of stock, or expiring soon.</p>
        </div>
    </div>
}

<style>
    @@media print {
        .sidebar, .top-header, .btn { display: none !important; }
        .main-content { margin: 0 !important; }
        .card { break-inside: avoid; }
    }
</style>
